package dev.binclub.binscure.processors.exploit

import dev.binclub.binscure.CObfuscator
import dev.binclub.binscure.IClassProcessor
import dev.binclub.binscure.configuration.ConfigurationManager.rootConfig
import dev.binclub.binscure.processors.runtime.OpaqueRuntimeManager
import dev.binclub.binscure.processors.runtime.randomOpaqueJump
import dev.binclub.binscure.utils.InstructionModifier
import dev.binclub.binscure.utils.newLabel
import org.objectweb.asm.Handle
import org.objectweb.asm.Opcodes
import org.objectweb.asm.tree.ClassNode
import org.objectweb.asm.tree.InsnList
import org.objectweb.asm.tree.InvokeDynamicInsnNode

/**
 * By adding an invokedynamic insn to a non existent bootstrap method we can crash procyon and similar bytecode parsers
 * (Sadly asm is immune)
 *
 * @author cookiedragon234 09/Mar/2020
 */
object BadIndyConstant: IClassProcessor {
	override fun process(classes: MutableCollection<ClassNode>, passThrough: MutableMap<String, ByteArray>) {
		if (!rootConfig.crasher.enabled)
			return
		
		for (classNode in classes) {
			if (CObfuscator.isExcluded(classNode))
				continue
			
			for (method in classNode.methods) {
				if (CObfuscator.isExcluded(classNode, method))
					continue
				
				if (method.instructions?.first == null)
					continue
				
				val modifier = InstructionModifier()
				
				val label = newLabel()
				val list = InsnList().apply {
					add(randomOpaqueJump(label))
					add(InvokeDynamicInsnNode(
						null, null, null
					))
					add(InvokeDynamicInsnNode(
						"", "()V", Handle(Opcodes.H_INVOKESTATIC, "a", "a", "(IIIIIIIIIIIIIIIIIIIIIIII)Ljava/lang/Throwable;")
					))
					add(label)
				}
				
				modifier.prepend(method.instructions.first, list)
				modifier.apply(method)
			}
		}
	}
}
